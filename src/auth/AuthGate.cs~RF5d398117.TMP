using BCrypt.Net;
using mynance.src.exceptions.auth;
using mynance.src.models;
using mynance.src.models.contexts;
using System;
using System.Collections.Generic;
using System.Diagnostics;
using System.Linq;
using System.Security.Cryptography.Xml;
using System.Text;
using System.Text.RegularExpressions;
using BC = BCrypt.Net.BCrypt;
namespace mynance.src.auth
{
    public partial class AuthGate
    {
        private readonly Regex usernameRegex = new("^[0-9a-zA-Z_]+$");
        public static User CurrentUser { get; private set; }
        public static int Role { get; private set; }

        public AuthGate() { }

        // TODO: implement proper return value and handling
        public void LoginUser(String username, String password) {
            if (username == null || password == null || username.Trim().Length == 0 || password.Trim().Length == 0)
                throw new EmptyFieldException("Username field cannot be empty.");

            if (usernameRegex.IsMatch(username) == false)
                throw new InvalidUsernameException("Invalid username.");

            UserContext ctx = new();
            User user = ctx.Users.Where(x => x.Username == username).FirstOrDefault() 
                ?? throw new NoUserExistsException(String.Format("User '{0}' does not exist.", username));

            if (BC.EnhancedVerify(password, user.Password) == false)
                throw new InvalidPasswordException("Invalid password.");
            UserRoleContext rolesCtx = new();
            try
            {
                UserRole role = rolesCtx.Roles.Where(ur => ur.username == username).FirstOrDefault();

                AuthGate.Role = role.role;
                AuthGate.CurrentUser = user;
            }
            catch (Exception e)
            {
                throw new NoUserExistsException(String.Format("User '{0}' is not assigned a role.", username));
            }
        }

        public void RegisterUser(String username, String password, String passwordRepeat, String fullName)
        {
            if (usernameRegex.IsMatch(username) == false)
                throw new InvalidUsernameException("Invalid username.");

            if (password != passwordRepeat)
                throw new InvalidPasswordException("Passwords do not match.");

            if (fullName == null)
                throw new EmptyFieldException("Full name field cannot be empty.");
            else if (fullName.Trim().Length == 0 || fullName.Trim() == "") 
                throw new EmptyFieldException("Full name field cannot be empty.");

            UserContext ctx = new();
            if (ctx.Users.Any(u => u.Username == username))
                throw new InvalidUsernameException("Username already taken.");

            User user = new()
            {
                Username = username,
                Password = BC.EnhancedHashPassword(password),
                FullName = fullName,
                RegistrationDate = DateTime.Now,
                LastActive = DateTime.Now
            };

            ctx.Users.Add(user);
            ctx.SaveChanges();

            UserRole role = new()
            {
                role = 2,
                username = username
            };
            UserRoleContext rolesCtx = new();
            rolesCtx.Roles.Add(role);
            rolesCtx.SaveChanges();
        }
    }
}
